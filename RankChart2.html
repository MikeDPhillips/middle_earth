<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v6.min.js"></script>
    <script src="https://d3js.org/d3-voronoi.v1.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:200,300,400,500,600" rel="stylesheet">
    <title>Rank Chart Example</title>
</head>
<body>

<div id="franchiseRank"></div>

<script>
    let margin = {top: 20, right: 30, bottom: 30, left: 60},
        width = 800
        height= 600
        chartWidth = width - margin.left - margin.right,
        chartHeight = height - margin.top - margin.bottom;

    let svg = d3.select("#franchiseRank").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .attr("id", "rankChart")
        .append("g")
        .attr("transform", "translate(" + margin.left + "," + margin.top + ")")

        svg.append("defs")
            .append("clipPath")
            .attr("id", "clip")
            .append("rect")
            .attr("width", width)
            .attr("height", height)

    d3.csv("franchises_medium.csv",d3.autoType).then((data)=>{
        console.log(data);
        let dateExtent = d3.extent(data, d=>d.Year);
        let countMax = d3.max(data, d=>d.Rank)
        let xScale = d3.scaleLinear().domain(dateExtent).range([margin.left, chartWidth]);
        let yScale = d3.scaleLinear().domain([1, countMax]).range([margin.bottom, chartHeight]);
        let yAxis = d3.axisLeft(yScale).ticks();
        let xAxis = d3.axisBottom(xScale)
            .tickFormat(d3.format("d"))
            .ticks(20)


        let line = d3.line()
            .x(d => xScale(d['Year']))
            .y(d => yScale(d['Rank']))
                // Uncomment this to use monotone curve
        //     	.curve(d3.curveMonotoneX);

        svg.append("g")
            .attr("transform","translate(" + margin.left + "," + margin.top + ")")
            .call(yAxis);

        svg.append("g")
            .attr("transform", "translate("+ margin.left + "," + chartHeight + ")")
            .call(xAxis);


        let nestedData =  d3.group(data, d=>d['Franchise'])
        let keyValue = Array.from(nestedData, ([key, value]) => ({key, value}))

        //Choose colors for each franchise
        let names = [...new Set(data.map(d => d.Franchise))];
        console.log(names)
        let colorScale = d3.scaleOrdinal().domain(names)
            .range(['#e41a1c','#377eb8','#4daf4a','#984ea3','#ff7f00','#ffbe33','#a65628','#f781bf','#4ec0c2'])


        let lines = svg.selectAll(".focus")
            .data(keyValue)
            .enter().append("g")
            .attr("class", function(d) {return "focus " + d.key;})
            .append("path")
            .on("mouseover", mouseover)
            .on("mouseout", mouseout)
            .attr("class", "line")
            .attr("clip-path", "url(#clip)")
            .style("pointer-events", "none")
            .style("stroke-linejoin", "round")
            .style("opacity", 0)
            .style("stroke-width", "none")
            .attr("fill", "none")
            .attr("d", function (d) {
                d.line = this;
                console.log(d.value)
                return line(d.value);
            })
            .style("stroke", d => colorScale(d.key))
            .transition().duration(750).delay(500)
            .style("opacity", 0.7);


//Voronoi mouseover and mouseout functions
        function mouseover(d) {
            focus.selectAll(".focus").style("opacity", 0.1);
            focus.selectAll("."+d.name).style("opacity", 0.8);
            //Move the tooltip to the front
            d3.select(".popUpName").moveToFront();
            //Change position, size of circle and text of tooltip
            popUpName.attr("transform", "translate(" + xScale(d.year) + "," + yScale(d.position) + ")");
            var circleSize = parseInt(d3.selectAll(".focus." + d.name).selectAll(".line").style("stroke-width"));
            popUpName.select(".tooltipCircle").style("fill", color(d.name)).attr("r", circleSize);
            popUpName.select("text").text(d.name);
        }//mouseover

        function mouseout(d) {
            focus.selectAll(".focus").style("opacity", 0.7);
            popUpName.attr("transform", "translate(-100,-100)");
        }//mouseout

//Move selected element to the front
        d3.selection.prototype.moveToFront = function() {
            return this.each(function(){
                this.parentNode.appendChild(this);
            });
        };


    });

    let popUpName = focus.append("g")
        .attr("transform", "translate(-100,-100)")
        .attr("class", "popUpName")
        .style("pointer-events", "none");

    popUpName.append("circle")
        .attr("class", "tooltipCircle")
        .attr("r", 3.5);

    popUpName.append("text")
        .style("font-size", 12)
        .attr("class", "titles")
        .attr("y", -15);


</script>

</body>
</html>